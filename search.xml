<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>iops查看</title>
    <url>/2024/01/11/iops%E6%9F%A5%E7%9C%8B/</url>
    <content><![CDATA[<h1 id="IOPS查看"><a href="#IOPS查看" class="headerlink" title="IOPS查看"></a>IOPS查看</h1><h3 id="iostat命令"><a href="#iostat命令" class="headerlink" title="iostat命令"></a>iostat命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#每隔5秒执行一次iostat，连续执行3次</span></span><br><span class="line">iostat -xmtc 5 3</span><br><span class="line">Linux 3.10.0-1160.92.1.el7.x86_64 (zhang)       10/17/2023      _x86_64_        (2 CPU)</span><br><span class="line"></span><br><span class="line">10/17/2023 08:19:03 PM</span><br><span class="line">avg-cpu:  %user   %<span class="built_in">nice</span> %system %iowait  %steal   %idle</span><br><span class="line">           0.62    0.00    0.24    0.05    0.00   99.09</span><br><span class="line"></span><br><span class="line">Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util</span><br><span class="line">vda               0.00     1.65    0.10    4.11     0.00     0.04    19.24     0.00    0.61    2.36    0.57   0.63   0.27</span><br><span class="line"></span><br><span class="line">– 设备（设备的名称）</span><br><span class="line">– rrqm/s（每秒钟进行的读操作的合并请求数）</span><br><span class="line">– wrqm/s（每秒钟进行的写操作的合并请求数）</span><br><span class="line">– r/s（每秒钟的读请求次数）</span><br><span class="line">– w/s（每秒钟的写请求次数）</span><br><span class="line">– rkB/s（每秒钟的读取数据量，单位KB）</span><br><span class="line">– wkB/s（每秒钟的写入数据量，单位KB）</span><br><span class="line">– avgrq-sz（每个请求的平均扇区数）</span><br><span class="line">– avgqu-sz（平均I / O请求数量）</span><br><span class="line">– awt（平均处理时间）</span><br><span class="line">– svctm（平均服务时间）</span><br><span class="line">– %util（每秒已使用磁盘时间的百分比）</span><br></pre></td></tr></table></figure>

<h3 id="dstat命令"><a href="#dstat命令" class="headerlink" title="dstat命令"></a>dstat命令</h3><p>dstat是一个系统资源统计工具，它能轻松监视系统的IOPS。它还可以报告CPU使用率、内存和磁盘使用率等更多指标。想要使用dstat，请使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@zhang ~]<span class="comment"># dstat -cdD total --disk-util --disk-tps --top-io-adv</span></span><br><span class="line">Module dstat_disk_util failed to load. (No counter objects to monitor)</span><br><span class="line">----total-cpu-usage---- -dsk/total- -dsk/total- -------most-expensive-i/o-process-------</span><br><span class="line">usr sys idl wai hiq siq| <span class="built_in">read</span>  writ|reads writs|process              pid  <span class="built_in">read</span> write cpu</span><br><span class="line">  1   0  99   0   0   0|2341B   38k|   0     4 |php-fpm: master proce31398  69k 199B0.0%</span><br><span class="line">  1   1  99   0   0   0|   0  8192B|   0     2 |postgres: zabbix zabb18738   0 8192B  0%</span><br><span class="line">  1   0  99   0   0   0|   0    12k|   0     3 |postgres: zabbix zabb18747   0 8192B  0%</span><br><span class="line">  1   1  99   0   0   0|   0    32k|   0     4 |postgres: zabbix zabb18736   0 8192B  0%</span><br><span class="line">  1   0  99   0   0   0|   0    12k|   0     3 |postgres: zabbix zabb18738   0 8192B  0%</span><br><span class="line">  1   1  99   0   0   0|   0    24k|   0     4 |postgres: zabbix zabb18735   0   16k  0%</span><br><span class="line">  1   1  99   0   0   0|   0  8192B|   0     2 |postgres: zabbix zabb18736   0 8192B  0%</span><br><span class="line">  1   1  99   0   0   0|   0    16k|   0     3 |postgres: zabbix zabb18747   0 8192B  0%</span><br><span class="line">  1   0  98   0   0   0|   0    56k|   0     4 |postgres: zabbix zabb18738   0 8192B  0%</span><br><span class="line">  1   1  98   0   0   0|   0  8192B|   0     2 |postgres: zabbix zabb18735   0 8192B  0%</span><br><span class="line">  1   0  99   0   0   0|   0  8192B|   0     2 |postgres: zabbix zabb18671   0 8192B  0%</span><br><span class="line">  2   1  98   0   0   0|   0   396k|   0     7 |postmaster           1314  550k   0   0%</span><br><span class="line">  1   1  99   0   0   0|   0    76k|   0    15 |node                 4925   11k  24k1.0%</span><br><span class="line">  2   0  98   0   0   0|   0    84k|   0     2 |zabbix_agentd: collec130521258B   0   0%</span><br><span class="line"> 15   2  82   2   0   0|7280k  144k| 223     8 |containerd-shim-runc-4875  105k  47k  0%^C</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
        <category>iops</category>
      </categories>
      <tags>
        <tag>磁盘读写</tag>
        <tag>iops</tag>
      </tags>
  </entry>
  <entry>
    <title>域控管理常用脚本</title>
    <url>/2024/05/01/%E5%9F%9F%E6%8E%A7%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h2 id="域控管理常用脚本"><a href="#域控管理常用脚本" class="headerlink" title="域控管理常用脚本"></a>域控管理常用脚本</h2><h3 id="1-批量创建用户-永不过期版"><a href="#1-批量创建用户-永不过期版" class="headerlink" title="1.批量创建用户(永不过期版)"></a>1.批量创建用户(永不过期版)</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 导入 CSV 文件，注意csv文件的编码和多余行，这个版本的账户默认为永不过期</span></span><br><span class="line"><span class="variable">$csvPath</span> = <span class="string">&quot;C:\user.csv&quot;</span></span><br><span class="line"><span class="variable">$users</span> = <span class="built_in">Import-Csv</span> <span class="variable">$csvPath</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置域控信息</span></span><br><span class="line"><span class="variable">$domainController</span> = <span class="string">&quot;testad.com&quot;</span></span><br><span class="line"><span class="variable">$ou</span> = <span class="string">&quot;OU=IT部门,OU=强盛集团,DC=testad,DC=com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环遍历 CSV 文件中的每一行</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span> <span class="keyword">in</span> <span class="variable">$users</span>) &#123;</span><br><span class="line">    <span class="comment"># 从 CSV 中获取用户信息</span></span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$user</span>.Username</span><br><span class="line">    <span class="variable">$firstname</span> = <span class="variable">$user</span>.FirstName</span><br><span class="line">    <span class="variable">$lastname</span> = <span class="variable">$user</span>.LastName</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$user</span>.Password</span><br><span class="line">    <span class="variable">$pager</span> = <span class="variable">$user</span>.Pager  <span class="comment"># 假设 CSV 有一个名为 Pager 的列</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将密码转换为安全字符串</span></span><br><span class="line">    <span class="variable">$securePassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> <span class="variable">$password</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 拼接姓名得到显示名称</span></span><br><span class="line">    <span class="variable">$displayName</span> = <span class="string">&quot;<span class="variable">$lastname</span><span class="variable">$firstname</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置邮箱地址</span></span><br><span class="line">    <span class="variable">$emailAddress</span> = <span class="string">&quot;<span class="variable">$username</span>@<span class="variable">$domainController</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建用户，添加显示名称和邮箱</span></span><br><span class="line">    <span class="built_in">New-ADUser</span> <span class="literal">-SamAccountName</span> <span class="variable">$username</span> `</span><br><span class="line">               <span class="literal">-UserPrincipalName</span> <span class="string">&quot;<span class="variable">$username</span>@<span class="variable">$domainController</span>&quot;</span> `</span><br><span class="line">               <span class="literal">-Name</span> <span class="string">&quot;<span class="variable">$lastname</span><span class="variable">$firstname</span>&quot;</span> `</span><br><span class="line">               <span class="literal">-GivenName</span> <span class="variable">$firstname</span> `</span><br><span class="line">               <span class="literal">-Surname</span> <span class="variable">$lastname</span> `</span><br><span class="line">               <span class="literal">-DisplayName</span> <span class="variable">$displayName</span> `</span><br><span class="line">               <span class="literal">-EmailAddress</span> <span class="variable">$emailAddress</span> `</span><br><span class="line">               <span class="literal">-AccountPassword</span> <span class="variable">$securePassword</span> `</span><br><span class="line">               <span class="literal">-CannotChangePassword</span> <span class="variable">$true</span> `</span><br><span class="line">               <span class="literal">-PasswordNeverExpires</span> <span class="variable">$true</span> `</span><br><span class="line">               <span class="literal">-Enabled</span> <span class="variable">$true</span> `</span><br><span class="line">               <span class="literal">-OtherAttributes</span> <span class="selector-tag">@</span>&#123;<span class="string">&#x27;pager&#x27;</span>=<span class="variable">$pager</span>&#125; `</span><br><span class="line">               <span class="literal">-Path</span> <span class="variable">$ou</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对应CSV文件结构"><a href="#对应CSV文件结构" class="headerlink" title="对应CSV文件结构"></a>对应CSV文件结构</h4><table>
<thead>
<tr>
<th align="center">Username</th>
<th align="center">LastName</th>
<th align="center">FirstName</th>
<th align="center">Password</th>
<th align="center">Pager</th>
</tr>
</thead>
</table>
<h3 id="2-批量创建用户-指定过期时间"><a href="#2-批量创建用户-指定过期时间" class="headerlink" title="2.批量创建用户(指定过期时间)"></a>2.批量创建用户(指定过期时间)</h3><ul>
<li>注意修改自己的OU等信息</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#下面是可以指定账户过期时间的版本</span></span><br><span class="line"><span class="comment"># 导入 CSV 文件</span></span><br><span class="line"><span class="variable">$csvPath</span> = <span class="string">&quot;C:\user.csv&quot;</span></span><br><span class="line"><span class="variable">$users</span> = <span class="built_in">Import-Csv</span> <span class="variable">$csvPath</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置域控信息</span></span><br><span class="line"><span class="variable">$domainController</span> = <span class="string">&quot;testad.com&quot;</span></span><br><span class="line"><span class="variable">$ou</span> = <span class="string">&quot;OU=外部公司,DC=testad,DC=com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环遍历 CSV 文件中的每一行</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span> <span class="keyword">in</span> <span class="variable">$users</span>) &#123;</span><br><span class="line">    <span class="comment"># 从 CSV 中获取用户信息</span></span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$user</span>.Username</span><br><span class="line">    <span class="variable">$firstname</span> = <span class="variable">$user</span>.FirstName</span><br><span class="line">    <span class="variable">$lastname</span> = <span class="variable">$user</span>.LastName</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$user</span>.Password</span><br><span class="line">    <span class="variable">$pager</span> = <span class="variable">$user</span>.Pager <span class="comment"># 假设 CSV 有一个名为 Pager 的列</span></span><br><span class="line">    <span class="variable">$accountExpirationDate</span> = <span class="variable">$user</span>.ExpirationDate <span class="comment"># 从 CSV 读取账户过期时间</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 将密码转换为安全字符串</span></span><br><span class="line">    <span class="variable">$securePassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> <span class="variable">$password</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 拼接姓名得到显示名称</span></span><br><span class="line">    <span class="variable">$displayName</span> = <span class="string">&quot;<span class="variable">$lastname</span><span class="variable">$firstname</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置邮箱地址</span></span><br><span class="line">    <span class="variable">$emailAddress</span> = <span class="string">&quot;<span class="variable">$username</span>@<span class="variable">$domainController</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$accountExpirationDate</span> = <span class="variable">$user</span>.ExpirationDate</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (![<span class="built_in">string</span>]::IsNullOrEmpty(<span class="variable">$accountExpirationDate</span>)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment"># 转换为 DateTime 对象</span></span><br><span class="line">        <span class="variable">$expirationDate</span> = [<span class="built_in">datetime</span>]::ParseExact(<span class="variable">$accountExpirationDate</span>, <span class="string">&#x27;yyyy-MM-dd&#x27;</span>, <span class="variable">$null</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添一天确保在指定时区的次日结束过期</span></span><br><span class="line">        <span class="variable">$expirationDate</span> = <span class="variable">$expirationDate</span>.AddDays(<span class="number">1</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Warning</span> <span class="string">&quot;无法解析用户 <span class="variable">$username</span> 的过期日期: &#x27;<span class="variable">$accountExpirationDate</span>&#x27;&quot;</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建用户，添加显示名称、邮箱和账户过期时间</span></span><br><span class="line">    <span class="built_in">New-ADUser</span> <span class="literal">-SamAccountName</span> <span class="variable">$username</span> `</span><br><span class="line">               <span class="literal">-UserPrincipalName</span> <span class="string">&quot;<span class="variable">$username</span>@<span class="variable">$domainController</span>&quot;</span> `</span><br><span class="line">               <span class="literal">-Name</span> <span class="string">&quot;<span class="variable">$displayName</span>&quot;</span> `</span><br><span class="line">               <span class="literal">-GivenName</span> <span class="variable">$firstname</span> `</span><br><span class="line">               <span class="literal">-Surname</span> <span class="variable">$lastname</span> `</span><br><span class="line">               <span class="literal">-DisplayName</span> <span class="variable">$displayName</span> `</span><br><span class="line">               <span class="literal">-EmailAddress</span> <span class="variable">$emailAddress</span> `</span><br><span class="line">               <span class="literal">-AccountPassword</span> <span class="variable">$securePassword</span> `</span><br><span class="line">               <span class="literal">-PasswordNeverExpires</span> <span class="variable">$true</span> `</span><br><span class="line">               <span class="literal">-CannotChangePassword</span> <span class="variable">$true</span> `</span><br><span class="line">               <span class="literal">-AccountExpirationDate</span> <span class="variable">$expirationDate</span> `</span><br><span class="line">               <span class="literal">-Enabled</span> <span class="variable">$true</span> `</span><br><span class="line">               <span class="literal">-OtherAttributes</span> <span class="selector-tag">@</span>&#123;<span class="string">&#x27;pager&#x27;</span>=<span class="variable">$pager</span>&#125; `</span><br><span class="line">               <span class="literal">-Path</span> <span class="variable">$ou</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对应CSV文件结构-1"><a href="#对应CSV文件结构-1" class="headerlink" title="对应CSV文件结构"></a>对应CSV文件结构</h4><table>
<thead>
<tr>
<th align="center">Username</th>
<th align="center">LastName</th>
<th align="center">FirstName</th>
<th align="center">Password</th>
<th align="center">Pager</th>
<th align="center">ExpirationDate</th>
</tr>
</thead>
</table>
<h3 id="3-批量修改账户过期时间"><a href="#3-批量修改账户过期时间" class="headerlink" title="3.批量修改账户过期时间"></a>3.批量修改账户过期时间</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"><span class="built_in">Import-Csv</span> <span class="string">&quot;C:\modify.csv&quot;</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">    <span class="comment"># 解析日期并加上一天</span></span><br><span class="line">    <span class="variable">$expiredate</span> = [<span class="built_in">DateTime</span>]::ParseExact(<span class="variable">$_</span>.expiredate, <span class="string">&quot;yyyy-MM-dd&quot;</span>, <span class="variable">$null</span>).AddDays(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">Set-ADUser</span> <span class="variable">$_</span>.username <span class="literal">-AccountExpirationDate</span> <span class="variable">$expiredate</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对应CSV文件结构-2"><a href="#对应CSV文件结构-2" class="headerlink" title="对应CSV文件结构"></a>对应CSV文件结构</h4><table>
<thead>
<tr>
<th align="center">username</th>
<th align="center">expiredate</th>
</tr>
</thead>
</table>
<h3 id="4-指定账户永不过期"><a href="#4-指定账户永不过期" class="headerlink" title="4.指定账户永不过期"></a>4.指定账户永不过期</h3><ul>
<li>有一个username列</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"><span class="built_in">Import-Csv</span> <span class="string">&quot;C:\modify.csv&quot;</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">    <span class="comment"># 设置用户账户为永不过期</span></span><br><span class="line">    <span class="built_in">Set-ADUser</span> <span class="variable">$_</span>.username <span class="literal">-AccountExpirationDate</span> <span class="variable">$null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-批量修改密码"><a href="#5-批量修改密码" class="headerlink" title="5.批量修改密码"></a>5.批量修改密码</h3><ul>
<li>csv要有一个sAMAccountName和password列</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$userlist</span> = <span class="built_in">Import-Csv</span> <span class="literal">-Path</span> <span class="string">&quot;C:\user.csv&quot;</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span> <span class="keyword">in</span> <span class="variable">$userlist</span>) &#123;</span><br><span class="line">    dsmod user (dsquery user <span class="literal">-samid</span> <span class="variable">$user</span>.sAMAccountName) <span class="literal">-pwd</span> <span class="variable">$user</span>.password</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-批量删除用户"><a href="#6-批量删除用户" class="headerlink" title="6.批量删除用户"></a>6.批量删除用户</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"><span class="built_in">Import-Csv</span> <span class="string">&quot;C:\deleteusers.csv&quot;</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">    <span class="comment"># 删除用户账户</span></span><br><span class="line">    <span class="built_in">Remove-ADUser</span> <span class="literal">-Identity</span> <span class="variable">$_</span>.username <span class="literal">-Confirm</span>:<span class="variable">$False</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-批量修改用户登录名"><a href="#7-批量修改用户登录名" class="headerlink" title="7.批量修改用户登录名"></a>7.批量修改用户登录名</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"><span class="built_in">Import-Csv</span> <span class="string">&quot;C:\username.csv&quot;</span> | <span class="built_in">ForEach-Object</span> &#123;</span><br><span class="line">    <span class="comment"># 获取当前用户的详细信息</span></span><br><span class="line">    <span class="variable">$user</span> = <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> <span class="string">&quot;SamAccountName -eq &#x27;<span class="variable">$</span>(<span class="variable">$_</span>.OldUsername)&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$user</span>) &#123;</span><br><span class="line">        <span class="comment"># 如果用户存在，则同时更新其 sAMAccountName、UserPrincipalName 和 mail</span></span><br><span class="line">        <span class="built_in">Set-ADUser</span> <span class="literal">-Identity</span> <span class="variable">$user</span> <span class="literal">-SamAccountName</span> <span class="variable">$_</span>.NewSamAccountName <span class="literal">-UserPrincipalName</span> <span class="variable">$_</span>.NewUserPrincipalName <span class="literal">-EmailAddress</span> <span class="variable">$_</span>.NewUserPrincipalName</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;Updated usernames and email for <span class="variable">$</span>(<span class="variable">$user</span>.Name): sAMAccountName to <span class="variable">$</span>(<span class="variable">$_</span>.NewSamAccountName), UserPrincipalName and EmailAddress to <span class="variable">$</span>(<span class="variable">$_</span>.NewUserPrincipalName)&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;User <span class="variable">$</span>(<span class="variable">$_</span>.OldUsername) not found.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>结构如下</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">OldUsername,NewSamAccountName,NewUserPrincipalName</span><br><span class="line">zhangdaniu,lierniu,lierniu@domain.com</span><br></pre></td></tr></table></figure>

<h3 id="8-批量允许用户可修改密码"><a href="#8-批量允许用户可修改密码" class="headerlink" title="8.批量允许用户可修改密码"></a>8.批量允许用户可修改密码</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#设置成true,原来状态是不允许的，就可以变成允许，因为域控写的是，“用户不能更改密码”</span></span><br><span class="line">Username,CanChangePassword</span><br><span class="line">pjt_zhanglinyan,<span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 导入Active Directory模块</span></span><br><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定CSV文件路径</span></span><br><span class="line"><span class="variable">$csvPath</span> = <span class="string">&quot;C:\passwd.csv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从CSV文件读取用户数据</span></span><br><span class="line"><span class="variable">$users</span> = <span class="built_in">Import-Csv</span> <span class="literal">-Path</span> <span class="variable">$csvPath</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span> <span class="keyword">in</span> <span class="variable">$users</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment"># 获取AD用户对象</span></span><br><span class="line">        <span class="variable">$adUser</span> = <span class="built_in">Get-ADUser</span> <span class="literal">-Identity</span> <span class="variable">$user</span>.Username <span class="literal">-Properties</span> CannotChangePassword</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 根据CSV文件设置&#x27;CannotChangePassword&#x27;属性</span></span><br><span class="line">        <span class="variable">$canChangePassword</span> = <span class="keyword">if</span> (<span class="variable">$user</span>.CanChangePassword <span class="operator">-eq</span> <span class="string">&#x27;true&#x27;</span>) &#123;<span class="variable">$false</span>&#125; <span class="keyword">else</span> &#123;<span class="variable">$true</span>&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新AD用户对象的属性</span></span><br><span class="line">        <span class="built_in">Set-ADUser</span> <span class="literal">-Identity</span> <span class="variable">$user</span>.Username <span class="literal">-CannotChangePassword</span> <span class="variable">$canChangePassword</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;已更新用户 <span class="variable">$</span>(<span class="variable">$user</span>.Username) 的密码修改设置。&quot;</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;无法更新用户 <span class="variable">$</span>(<span class="variable">$user</span>.Username) 的设置。错误: <span class="variable">$_</span>&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="9-批量禁用域账户"><a href="#9-批量禁用域账户" class="headerlink" title="9.批量禁用域账户"></a>9.批量禁用域账户</h3><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 导入Active Directory模块，如果未安装可能需要先安装RSAT工具</span></span><br><span class="line"><span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定CSV文件路径</span></span><br><span class="line"><span class="variable">$csvPath</span> = <span class="string">&quot;C:\aban.csv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从CSV文件中读取用户名</span></span><br><span class="line"><span class="variable">$users</span> = <span class="built_in">Import-Csv</span> <span class="literal">-Path</span> <span class="variable">$csvPath</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历每一个用户名，并尝试禁用对应的AD账户</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$user</span> <span class="keyword">in</span> <span class="variable">$users</span>) &#123;</span><br><span class="line">    <span class="comment"># 获取AD用户对象</span></span><br><span class="line">    <span class="variable">$adUser</span> = <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> <span class="string">&quot;SamAccountName -eq &#x27;<span class="variable">$</span>(<span class="variable">$user</span>.Username)&#x27;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果用户存在，则禁用账户</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$adUser</span>) &#123;</span><br><span class="line">        <span class="built_in">Disable-ADAccount</span> <span class="literal">-Identity</span> <span class="variable">$adUser</span></span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;User <span class="variable">$</span>(<span class="variable">$user</span>.Username) has been disabled.&quot;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">&quot;User <span class="variable">$</span>(<span class="variable">$user</span>.Username) not found.&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>WinServer</category>
        <category>域控</category>
      </categories>
      <tags>
        <tag>域控</tag>
        <tag>powershell</tag>
        <tag>AD</tag>
      </tags>
  </entry>
</search>
